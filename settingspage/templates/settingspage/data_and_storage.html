{% extends 'settingspage/settings_base.html' %}
{% load static %}
{% load i18n %}

{% block settings_content %}
<div class="settings-section">
    <h2 class="settings-section-title">
        <i class="fas fa-database"></i> {% translate "Data & Storage Settings" %}
    </h2>

    <!-- Storage Usage Section -->
    <div class="settings-subsection">
        <h3 class="settings-subtitle">
            <i class="fas fa-chart-pie"></i> {% translate "Storage Usage" %}
        </h3>

        <div class="storage-usage-container">
            <div class="storage-progress">
                <div class="progress-bar" style="width: {{ storage_usage.percentage }}%"></div>
            </div>
            <div class="storage-stats">
                <span>{{ storage_usage.used|filesizeformat }} {% translate "of" %} {{ storage_usage.total|filesizeformat }} {% translate "used" %}</span>
                <span>{{ storage_usage.percentage }}% {% translate "used" %}</span>
            </div>
        </div>

        <div class="storage-details">
            <div class="storage-category">
                <div class="category-info">
                    <i class="fas fa-image"></i>
                    <span>{% translate "Media Files" %}</span>
                </div>
                <div class="category-size">{{ storage_usage.media|filesizeformat }}</div>
            </div>
            <div class="storage-category">
                <div class="category-info">
                    <i class="fas fa-file-alt"></i>
                    <span>{% translate "Documents" %}</span>
                </div>
                <div class="category-size">{{ storage_usage.documents|filesizeformat }}</div>
            </div>
            <div class="storage-category">
                <div class="category-info">
                    <i class="fas fa-code"></i>
                    <span>{% translate "Application Data" %}</span>
                </div>
                <div class="category-size">{{ storage_usage.app_data|filesizeformat }}</div>
            </div>
            <div class="storage-category">
                <div class="category-info">
                    <i class="fas fa-archive"></i>
                    <span>{% translate "Other" %}</span>
                </div>
                <div class="category-size">{{ storage_usage.other|filesizeformat }}</div>
            </div>
        </div>
    </div>

    <!-- Data Export Section -->
    <div class="settings-subsection">
        <h3 class="settings-subtitle">
            <i class="fas fa-download"></i> {% translate "Data Export" %}
        </h3>

        <div class="setting-item">
            <div class="setting-info">
                <h3 class="setting-title">{% translate "Export Your Data" %}</h3>
                <p class="setting-description">
                    {% translate "Download a copy of all your data in JSON format" %}
                </p>
            </div>
            <div class="setting-control">
                <button type="button" class="cta-button primary" onclick="exportUserData()">
                    <i class="fas fa-file-export"></i> {% translate "Export Data" %}
                </button>
            </div>
        </div>

        <div class="export-history">
            <h4>{% translate "Previous Exports" %}</h4>
            {% if export_history %}
                <ul class="export-list">
                    {% for export in export_history %}
                    <li class="export-item">
                        <div class="export-info">
                            <i class="fas fa-file-archive"></i>
                            <span class="export-date">{{ export.created_at|date:"DATETIME_FORMAT" }}</span>
                            <span class="export-size">{{ export.size|filesizeformat }}</span>
                        </div>
                        <div class="export-actions">
                            <a href="{{ export.download_url }}" class="download-link" download>
                                <i class="fas fa-download"></i> {% translate "Download" %}
                            </a>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="no-exports">{% translate "No previous exports found" %}</p>
            {% endif %}
        </div>
    </div>

    <!-- Data Cleanup Section -->
    <div class="settings-subsection">
        <h3 class="settings-subtitle">
            <i class="fas fa-trash-alt"></i> {% translate "Data Cleanup" %}
        </h3>

        <div class="setting-item">
            <div class="setting-info">
                <h3 class="setting-title">{% translate "Clear Cache" %}</h3>
                <p class="setting-description">
                    {% translate "Remove temporary files to free up space" %}
                </p>
            </div>
            <div class="setting-control">
                <button type="button" class="cta-button secondary" onclick="clearCache()">
                    <i class="fas fa-broom"></i> {% translate "Clear Now" %}
                </button>
            </div>
        </div>

        <div class="setting-item">
            <div class="setting-info">
                <h3 class="setting-title">{% translate "Auto-Cleanup" %}</h3>
                <p class="setting-description">
                    {% translate "Automatically clear temporary files older than" %}
                </p>
            </div>
            <div class="setting-control">
                <select name="auto_cleanup" class="form-control">
                    <option value="never" {% if auto_cleanup == 'never' %}selected{% endif %}>
                        {% translate "Never" %}
                    </option>
                    <option value="7" {% if auto_cleanup == '7' %}selected{% endif %}>
                        {% translate "7 days" %}
                    </option>
                    <option value="30" {% if auto_cleanup == '30' %}selected{% endif %}>
                        {% translate "30 days" %}
                    </option>
                    <option value="90" {% if auto_cleanup == '90' %}selected{% endif %}>
                        {% translate "90 days" %}
                    </option>
                </select>
            </div>
        </div>
    </div>

    <!-- Danger Zone Section -->
    <div class="settings-subsection danger-zone">
        <h3 class="settings-subtitle">
            <i class="fas fa-exclamation-triangle"></i> {% translate "Danger Zone" %}
        </h3>

        <div class="setting-item">
            <div class="setting-info">
                <h3 class="setting-title">{% translate "Delete All Data" %}</h3>
                <p class="setting-description">
                    {% translate "Permanently delete all your data including media, documents and account information" %}
                </p>
            </div>
            <div class="setting-control">
                <button type="button" class="cta-button danger" onclick="showDeleteDataModal()">
                    <i class="fas fa-trash"></i> {% translate "Delete All Data" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Data Modal -->
<div id="deleteDataModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>{% translate "Confirm Data Deletion" %}</h3>
            <button class="modal-close" onclick="hideDeleteDataModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="warning-message">
                <i class="fas fa-exclamation-circle"></i>
                <p>{% translate "This action will permanently delete ALL your data including:" %}</p>
                <ul>
                    <li>{% translate "Account information" %}</li>
                    <li>{% translate "Uploaded media files" %}</li>
                    <li>{% translate "Documents and other content" %}</li>
                    <li>{% translate "Activity history" %}</li>
                </ul>
                <p><strong>{% translate "This cannot be undone!" %}</strong></p>
            </div>

            <form method="post" id="deleteDataForm">
                {% csrf_token %}
                <div class="form-group">
                    <label for="confirmDeletePassword">{% translate "Enter your password to confirm:" %}</label>
                    <input type="password" class="form-control" id="confirmDeletePassword" name="confirm_password" required>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="cta-button secondary" onclick="hideDeleteDataModal()">
                {% translate "Cancel" %}
            </button>
            <button type="submit" form="deleteDataForm" name="delete_all_data" class="cta-button danger">
                {% translate "Permanently Delete All Data" %}
            </button>
        </div>
    </div>
</div>

<style>
    /* Storage Usage Styles */
    .storage-usage-container {
        margin-bottom: 25px;

    }

    .storage-progress {
        height: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        overflow: hidden;
        margin-bottom: 8px;
        width: 90%;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #ffcc00, #ffaa00);
        transition: width 0.5s ease;
    }

    .storage-stats {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.8);
        width: 90%;
    }

    .storage-details {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 15px;
        width: 90%;
    }

    .storage-category {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .storage-category:last-child {
        border-bottom: none;
    }

    .category-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .category-info i {
        color: #ffcc00;
        width: 20px;
        text-align: center;
    }

    /* Export History Styles */
    .export-history {
        margin-top: 30px;
    }

    .export-history h4 {
        margin-bottom: 15px;
        color: rgba(255, 255, 255, 0.9);
    }

    .export-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .export-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        margin-bottom: 10px;
    }

    .export-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .export-date {
        color: rgba(255, 255, 255, 0.9);
    }

    .export-size {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.9rem;
    }

    .download-link {
        color: #ffcc00;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .download-link:hover {
        text-decoration: underline;
    }

    .no-exports {
        color: rgba(255, 255, 255, 0.6);
        font-style: italic;
    }

    /* Danger Zone Styles */
    .danger-zone {
        border: 1px solid rgba(255, 0, 0, 0.2);
        background: rgba(255, 0, 0, 0.05);
        border-radius: 8px;
        padding: 20px;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: #2a2a3a;
        border-radius: 10px;
        width: 500px;
        max-width: 90%;
        box-shadow: 0 5px 30px rgba(0, 0, 0, 0.4);
        animation: modalFadeIn 0.3s ease-out;
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        color: white;
    }

    .modal-close {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.6);
        font-size: 1.8rem;
        cursor: pointer;
        line-height: 1;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        padding: 15px 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .warning-message {
        background: rgba(255, 0, 0, 0.1);
        border-left: 3px solid #ff4444;
        padding: 15px;
        margin-bottom: 20px;
    }

    .warning-message i {
        color: #ff4444;
        font-size: 1.5rem;
        margin-bottom: 10px;
        display: block;
    }

    .warning-message ul {
        margin: 10px 0 10px 20px;
        padding: 0;
    }

    .warning-message li {
        margin-bottom: 5px;
    }

    .danger-zone{
      width: 90%;
    }

    @keyframes modalFadeIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .setting-item{
        width: 90%;
    }
</style>

<script>
    // Export Data Function
    function exportUserData() {
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% translate "Preparing export..." %}';
        button.disabled = true;

        fetch('/api/export-data/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('{% translate "Your data export has been started. You will receive a notification when it\'s ready to download." %}');
                setTimeout(() => location.reload(), 3000);
            } else {
                alert('{% translate "Error exporting data: " %}' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% translate "An error occurred while exporting your data. Please try again later." %}');
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }

    // Clear Cache Function
    function clearCache() {
        if (confirm('{% translate "Are you sure you want to clear all cached data?" %}')) {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% translate "Clearing..." %}';
            button.disabled = true;

            fetch('/api/clear-cache/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('{% translate "Cache cleared successfully. Freed up space: " %}' + data.freed_space);
                    location.reload();
                } else {
                    alert('{% translate "Error clearing cache: " %}' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('{% translate "An error occurred while clearing cache. Please try again later." %}');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }
    }

    // Modal Functions
    function showDeleteDataModal() {
        document.getElementById('deleteDataModal').style.display = 'flex';
        setTimeout(() => {
            document.getElementById('deleteDataModal').style.opacity = '1';
        }, 10);
        document.getElementById('confirmDeletePassword').focus();
    }

    function hideDeleteDataModal() {
        document.getElementById('deleteDataModal').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('deleteDataModal').style.display = 'none';
        }, 300);
    }

    // Close modal when clicking outside
    document.getElementById('deleteDataModal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideDeleteDataModal();
        }
    });

    // Close modal with ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('deleteDataModal').style.display === 'flex') {
            hideDeleteDataModal();
        }
    });
</script>
{% endblock %}